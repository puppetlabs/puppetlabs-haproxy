<% if @weights -%>

<% Array(@ipaddresses).zip(Array(@server_names), Array(@weights)).each do |ipaddress,host,weight| -%>
<% if @ports -%>
<%- Array(@ports).each do |port| -%>
  server <%= host %> <%= ipaddress %>:<%= port %> weight <%= weight %><%= if @define_cookies then " cookie " + host end %> <%= Array(@options).sort.join(" ") %>
<%- end -%>
<% else -%>
  server <%= host %> <%= ipaddress %><%= if @define_cookies then " cookie " + host end %> <%= Array(@options).sort.join(" ") %>
<%- end -%>
<% end -%>

<% else -%>

<% Array(@ipaddresses).zip(Array(@server_names)).each do |ipaddress,host| -%>
<% if @ports -%>
<%- Array(@ports).each do |port| -%>
  server <%= host %> <%= ipaddress %>:<%= port %><%= if @define_cookies then " cookie " + host end %> <%= Array(@options).sort.join(" ") %>
<%- end -%>
<% else -%>
  server <%= host %> <%= ipaddress %><%= if @define_cookies then " cookie " + host end %> <%= Array(@options).sort.join(" ") %>
<%- end -%>
<% end -%>

<% end -%>
